<!doctype html><html prefix="og: https://ogp.me/ns#" lang=en data-theme=light><head><meta charset=utf-8><title itemprop=name>Audio Player in Js - Self-Review #1 :: The Upside-Down Trees</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Amiri&family=Montserrat&display=swap" rel=stylesheet><meta property="og:title" content="Audio Player in Js - Self-Review #1 | The Upside-Down Trees"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Audio Player in Js - Self-Review #1 | The Upside-Down Trees"><meta itemprop=name content="Audio Player in Js - Self-Review #1 | The Upside-Down Trees"><meta name=application-name content="Audio Player in Js - Self-Review #1 | The Upside-Down Trees"><meta property="og:site_name" content="blog.mhashim6.me"><meta name=description content="Code-Review on an Audio Player lib in JavaScript"><meta itemprop=description content="Code-Review on an Audio Player lib in JavaScript"><meta property="og:description" content="Code-Review on an Audio Player lib in JavaScript"><meta name=twitter:description content="Code-Review on an Audio Player lib in JavaScript"><base href=https://blog.mhashim6.me/audio-player-code-review/><link rel=canonical href=https://blog.mhashim6.me/audio-player-code-review/ itemprop=url><meta name=url content="https://blog.mhashim6.me/audio-player-code-review/"><meta name=twitter:url content="https://blog.mhashim6.me/audio-player-code-review/"><meta property="og:url" content="https://blog.mhashim6.me/audio-player-code-review/"><meta property="og:locale" content="en"><meta name=language content="English"><meta itemprop=image content="https://blog.mhashim6.me/images/self-review/self-review-1.png"><meta property="og:image" content="https://blog.mhashim6.me/images/self-review/self-review-1.png"><meta property="og:updated_time" content="282828-1111-120T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=https://blog.mhashim6.mesitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content="@UpsideDownTrees"><link rel=apple-touch-icon sizes=180x180 href=https://blog.mhashim6.me/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.mhashim6.me/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.mhashim6.me/favicon-16x16.png><link rel="shortcut icon" href=https://blog.mhashim6.me/favicon.ico><link rel=icon type=image/x-icon sizes="16x16 32x32" href=https://blog.mhashim6.me/favicon.ico><link rel=manifest href=https://blog.mhashim6.me/site.webmanifest><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#EDE3D9"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#17191C"><link rel=author href=https://blog.mhashim6.me/humans.txt><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"UpsideDownTrees","url":"https://blog.mhashim6.me","sameAs":["https://mhashim6.me","https://linkedin.com/in/mhashim6","https://github.com/mhashim6"]}</script><script>const storage=localStorage.getItem("dark-mode");("dark"===storage||!storage&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.setAttribute("data-theme","dark")</script><script src=https://blog.mhashim6.me/js/darkm.min.1be248604351b865213d07e5a761998a21e20d82ba86c4fe72cddc853f108b7d.js></script>
<link rel=stylesheet href=https://blog.mhashim6.me/css/style.min.f712d3066c83f8c551d9a8425323f155438cfd21fdf508d64194a7115e1b6a9f.css><link rel=stylesheet href=css/synatx.css><script defer data-domain=mhashim.me src=https://plausible.io/js/script.js></script></head><body class=single><header class=site-header><link rel=alternate type=application/rss+xml href=https://blog.mhashim6.me/index.xml title="The Upside-Down Trees"><div class=inner><p class="site-title slide-horizontal-invert"><a href=https://blog.mhashim6.me/>UpsideDownTrees</a></p><input type=checkbox id=check-menu class=check-menu hidden>
<label for=check-menu class="nav-btn hide-desktop" aria-label="Open/close menu"><span class=lines></span></label><nav class="site-nav hide-mobile slide-horizontal"><button class="theme__btn light--hidden" aria-label="Enable light mode"><svg aria-hidden="true" viewBox="0 0 24 24" id="sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
<button class="theme__btn dark--hidden" aria-label="Enable dark mode"><svg aria-hidden="true" viewBox="0 0 24 24" id="moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button><ul class=site-menu><li><a target=_blank href=https://t.me/UpsideDownTrees><span>Telegram</span></a></li><li><a target=_blank href=https://mhashim6.me><span>About me?</span></a></li><li><a href=https://blog.mhashim6.me/index.xml><span>RSS</span></a></li><li><a href=https://blog.mhashim6.me/posts/><span>Archive</span></a></li></ul></nav></div></header><main class=site-main><article><header class=subheader style=background-image:url(/images/self-review/self-review-1.png)><div class="title-container slide-invert"><h1 class=post-title>Audio Player in Js - Self-Review #1</h1><figcaption><i></i></figcaption><div><div class=taxonomy><a class="chip no-decor" href=https://blog.mhashim6.me/tags/code-review>Code-Review</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/audio-player>Audio player</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/javascript>javascript</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/open-source>Open-Source</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/github>GitHub</a></div></div></div></header><div class="content slide-invert"><blockquote><p>This is the first post in an ongoing series of Self-Code-Review. Where I pick <em>subjectively</em> unique and interesting modules, in different projects, architectures, and languages.</p></blockquote><blockquote><p>It’s not always the code that matters, it’s the critiques and observations that we will learn most from.</p></blockquote><p>I know you guys have a tendency to skip through the whole thing only looking for the text in a <code>monospace</code> typeface <em>(Don’t deny it)</em> so I’ve something just for you: A collapsible text that you only have to read if you think it’s starting to get interesting.</p><details><summary>What is this? What am I doing here?</summary><p>We all have this moment when we look back at older code, take some time to remember that it was us who wrote it, and then feel happy that we can now tell how horrible it is, and how we could improve it now, just to loath it again 6 months in the future.<p>This is basically it: In every post in this series I’ll provide a guide on how to build a certain feature/component. And then iterate on it pinpointing what could be better, what could be added, and why some things need to remain the way they are.</p></details><h2 id=audio-player-library>Audio-Player Library</h2><p>We finally made it here! We want to make a reusable, typical audio player API that we can later use in many contexts be it user interaction or a response to an app event…etc.</p><p>We need to define some core functionality that should exist in a standard audio player:</p><ul><li>play audio <em>(Oh my goodness, gracious me!)</em></li><li>pause audio</li><li>resume audio</li><li>stop audio</li><li>play multiple audio(<em>s?</em>)</li><li>repeat/ loop</li></ul><p>And to be more realistic we need some way to know what’s actually going on, they call that event listeners:</p><ul><li>onPlay</li><li>onTimeUpdate</li><li>onPause</li><li>onStop</li></ul><hr><h2 id=making-some-noise>Making some noise</h2><p>Like a good API, ours shouldn’t make assumptions about who is using it. It shouldn’t matter if it’s a react component or the man sitting inside your TV.</p><details><summary>Just hook into an <code>audio</code> tag mate! <i>(you think?)</i></summary><p>We can’t rely on UI (or in this case the <code>DOM</code>) to make our native audio player (even though we can totally do it this way). It’d be much better if our code is self-sufficient and reusable in many scenarios.</p></details><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>let</span> <span class=nx>player</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Audio</span><span class=p>();</span>
</span></span></code></pre></div><p>Luckily for us, we have a native <code>Audio</code> API in Js that we can <del>ab</del>use. It gives us primitives that we can build upon much more sophisticated functionalities.</p><p>Let’s start simple and <code>play</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>play</span> <span class=o>=</span> <span class=p>(</span><span class=nx>url</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><details><summary>We made some bold decisions here!</summary><p>First we accept the audio to play in the form of a <code>url string</code>. One would think that's not the most future proof choice to make; A wrapper object of sorts that encapsulates the format of audio file to play would be better and can be easier to tweak in the future.</p><p>A counter argument would be that's not very likely (in the context of the project this was built in) that this api will be going to do more. Future proofing is always good, but realism and time constrains should always govern all decisions.</p><p>Personally? I think it's not that complex or lengthy to implement a wrapper for our audio uri. I was just being lazy.</p><p>We also added a call to <code>stop()</code>! Why? It's the cheap way of running things in order. What is <code>stop()</code>? Glad you asked!</p></details><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>stop</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>pause</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>currentTime</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Yes, it&rsquo;s like manually adjusting your tape player.</p><p>How can we improve this? I think a sharp <strong>STOP</strong> isn&rsquo;t exactly polite and not what you want to hear, it&rsquo;d be sweet to add some fading effect. But yeah, total perfectionism.</p><p>Two core functionalities remain:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>resume</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>pause</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>pause</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><details><summary>Now we're ready to discuss a bigger design choice: Why is it all just functions?</summary><p>It's not a paradigm war, if you put this code inside a class, you'll probably instantiate one object to use in your app. For some folk this is known as a <code>static class</code>. And this is just another fancy word for redundancy.</p></details><hr><h2 id=events>Events</h2><p>This is my <code>onPlay</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onPlay</span> <span class=o>=</span> <span class=p>(</span><span class=nx>action</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cb</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>action</span><span class=p>(</span><span class=nx>player</span><span class=p>.</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;play&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;play&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Simple as it is, it gives the user a way out by returning a function that unsubscribes from the event.</p><p>The same applies to other events</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onTimeUpdate</span> <span class=o>=</span> <span class=p>(</span><span class=nx>action</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cb</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>action</span><span class=p>(</span><span class=nx>player</span><span class=p>.</span><span class=nx>src</span><span class=p>,</span> <span class=nx>player</span><span class=p>.</span><span class=nx>currentTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;timeupdate&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;timeupdate&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onPause</span> <span class=o>=</span> <span class=p>(</span><span class=nx>action</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cb</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>action</span><span class=p>(</span><span class=nx>player</span><span class=p>.</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;pause&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;pause&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onStop</span> <span class=o>=</span> <span class=p>(</span><span class=nx>action</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cb</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>action</span><span class=p>(</span><span class=nx>player</span><span class=p>.</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><hr><h2 id=a-playlist>A playlist</h2><p>Our lib now is good at playing one audio at a time, this is good. It&rsquo;s also useless TBH. How can we make that <em>(a playlist)</em> happen using the primitives we originally had and the ones we created?</p><p>We know we don&rsquo;t have a way to add multiple sources to our player, so we have to make our own way of queuing these audio sources</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>let</span> <span class=nx>queue</span> <span class=o>=</span> <span class=p>[];</span>
</span></span></code></pre></div><p>This simple <code>queue</code> holds our audio urls. We can now play one audio after the other as soon as it&rsquo;s finished playing. We have a way to know if an audio is started or stopped. We&rsquo;ll definitely take advantage of that</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>playlist</span><span class=p>(</span><span class=nx>queue</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>playlist</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>urls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>clear</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>queue</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=nx>queue</span><span class=p>.</span><span class=nx>push</span><span class=p>(...</span><span class=nx>urls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>upcoming</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>upcoming</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Because we don&rsquo;t have control over when the audio ends (we can&rsquo;t always end it ourselves), we can&rsquo;t iterate on the queue and play its contents one by one. So we have to use recursion <em>(always exciting, isn&rsquo;t it?)</em></p><p>We first declared a <code>next()</code> function that calls <code>playlist()</code> again when the <code>ended</code> event fires. And we stop doing that when the queue is empty.</p><p>We also added the option to start a new playlist by providing a <code>clear</code> flag. Neat!</p><h3 id=how-to-loop>How to loop?</h3><p>At first, we could just add another flag and call it a day, but it becomes more complicated</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>playlist</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>urls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>loop</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>Our <code>next()</code> now has to support this flag as well but wait! What&rsquo;s it gonna be? <code>true</code>? to always loop, or <code>false</code>? It can&rsquo;t be <code>false</code> though otherwise we&rsquo;d not have implemented it in the first place.</p><p>Here is the part of code that reminds you that nothing can be perfect. You add a hack to support a false sense of dynamic setting of the <code>loop</code> flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>playlist</span><span class=p>(</span><span class=nx>queue</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>nextLoop</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>playlist</span><span class=p>(</span><span class=nx>queue</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span></code></pre></div><p>We&rsquo;ll have to update our logic to fit the new hacky <code>nextLoop()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>upcoming</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>loop</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queue</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>upcoming</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>upcoming</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>loop</span> <span class=o>?</span> <span class=nx>nextLoop</span> <span class=o>:</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>loop</span> <span class=o>?</span> <span class=nx>nextLoop</span> <span class=o>:</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>loop</span> <span class=o>?</span> <span class=nx>nextLoop</span> <span class=o>:</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p>Yep, it lost its beauty. I won&rsquo;t even comment on the <code>loop ? nextLoop : next</code> part. You know what&rsquo;s wrong with it and how to improve it.</p><p>But it&rsquo;s not even done yet! We still need a way to notify the caller when each audio in the playlist is about to be played. We&rsquo;ll have to accept a callback to do that</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>onPlayNext</span> <span class=o>=</span> <span class=p>(</span><span class=nx>url</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>({});</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>playlist</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>urls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>loop</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>onNext</span> <span class=o>=</span> <span class=nx>onPlayNext</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>And in the function body we modified it a little</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>player</span><span class=p>.</span><span class=nx>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=nx>onNext</span><span class=p>(</span><span class=nx>upcoming</span><span class=p>);</span> <span class=c1>// readability: 0
</span></span></span></code></pre></div><p>What saddens me most is that Javascript acts weird when you use default arguments in your functions; Even though we added a default callback in case the user doesn&rsquo;t want to use this feature, this has an effect of permanently calling the default value even if the user supplied their own! <em>Classic JavaScript eh?</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>let</span> <span class=nx>onPlayNext</span> <span class=o>=</span> <span class=p>(</span><span class=nx>url</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>({});</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>playlist</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>urls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>loop</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>onNext</span> <span class=o>=</span> <span class=nx>onPlayNext</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>onPlayNext</span> <span class=o>=</span> <span class=nx>onNext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><details><summary>This is the ugly fix in case you're wondering. And it brings problems of its own</summary><p>You're now playing with globals that can very easily interleave. Yes, Js is single-threaded but it's possible to have all sorts of fun race conditions when using the event loop. We'll tap on that later.</p><p>We also have a very ugly and confusing code to handle <code>onNext</code>.</p></details><p>I&rsquo;ll have to ask you to remember that we also have a <code>play()</code> function that plays singular audio. It was calling <code>stop()</code> before and that was nice. But now that we introduced <code>playlist()</code>, our <code>stop()</code> won&rsquo;t be as powerful. We have to <em>reset</em> the playlist whenever we call <code>stop()</code> just in case it was playing.</p><p>We can make life easier for us by adding a <code>clear()</code> function that..<em>clears</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>clear</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queue</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;ended&#34;</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>When we <code>clear()</code> the queue, it&rsquo;s pretty clear <em>(no pun intended)</em> that we lost interest in the current queue and/or audio. We no longer need to play the next audio because there isn&rsquo;t one. that&rsquo;s why we removed the <code>ended</code> listener. Now our <code>stop()</code> can look like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>stop</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>pause</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>player</span><span class=p>.</span><span class=nx>currentTime</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><hr><h2 id=afterthoughts>Afterthoughts</h2><p>You now reached the state I was in when I first worked on that project. But you know much better of its pitfalls and why it is the way it is. We can now briefly talk improvements:</p><ul><li>This can be safer by declaring the APIs as <code>async</code>. Sure it&rsquo;ll introduce complexity but can provide safe access to state</li><li><code>loop</code> shouldn&rsquo;t be a luggage to carry, it can be better represented as a state</li><li>Don&rsquo;t let js stop your dreams; check if <code>onNext</code> is null instead of the default function arg</li><li>Insert yours here!</li></ul><hr><p><strong>Ps</strong>: Full code can be found on <a href=https://github.com/mhashim6/self-review/tree/main/audio-player>GitHub</a></p><button onclick='(()=>{navigator.share({url:"https://blog.mhashim6.me/audio-player-code-review/"})})()'>
Share This Post <img src=https://img.icons8.com/ios-glyphs/22/17191C/share-rounded.png></button><div class=taxonomy><a class="chip category" href=https://blog.mhashim6.me/categories/self-review-series>Self-Review-Series</a>
<a class="chip category" href=https://blog.mhashim6.me/categories/tech>Tech</a>
<a class="chip category" href=https://blog.mhashim6.me/categories/guide>Guide</a></div><script id=telegram_comments async src=https://comments.app/js/widget.js?3 data-comments-app-website=b14MWwEx data-limit=1000 data-page-id=https://blog.mhashim6.me/audio-player-code-review/ data-color=ceaa37 data-colorful=1 dark=0></script></div></article></main><footer class=site-footer><p class=copyright>© 2022 The Upside-Down Trees</p><ul class=social-links><li><a target=_blank class='icon icon-website' href=https://mhashim6.me aria-label="Follow on Website"></a></li><li><a target=_blank class='icon icon-linkedin' href=https://www.linkedin.com/in/mhashim6/ aria-label="Follow on LinkedIn"></a></li><li><a target=_blank class='icon icon-github' href=https://github.com/mhashim6 aria-label="Follow on GitHub"></a></li><li><a target=_blank class='icon icon-telegram' href=https://t.me/mhashim6 aria-label="Follow on Telegram"></a></li><li><a target=_blank class='icon icon-email' href=mailto:msg@mhashim6.me aria-label="Follow on Email"></a></li></ul></footer><script src=https://blog.mhashim6.me/js/prefixfree.min.9cea59c2cb403a83a6549aadada301521cf8b59b1abc0498e0a10432d186bd67.js></script></body></html>