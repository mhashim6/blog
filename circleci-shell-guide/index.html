<!doctype html><html prefix="og: https://ogp.me/ns#" lang=en data-theme=light><head><meta charset=utf-8><title itemprop=name>The Missing Docs on CircleCI (+Shell) :: The Upside-Down Trees</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Amiri&family=Montserrat&display=swap" rel=stylesheet><meta property="og:title" content="The Missing Docs on CircleCI (+Shell) | The Upside-Down Trees"><meta name=twitter:title content="The Missing Docs on CircleCI (+Shell) | The Upside-Down Trees"><meta itemprop=name content="The Missing Docs on CircleCI (+Shell) | The Upside-Down Trees"><meta name=application-name content="The Missing Docs on CircleCI (+Shell) | The Upside-Down Trees"><meta property="og:site_name" content="blog.mhashim6.me"><meta name=description content="Tools & Tips to tackle edge cases and advanced scenarios when working with CircleCi"><meta itemprop=description content="Tools & Tips to tackle edge cases and advanced scenarios when working with CircleCi"><meta property="og:description" content="Tools & Tips to tackle edge cases and advanced scenarios when working with CircleCi"><meta name=twitter:description content="Tools & Tips to tackle edge cases and advanced scenarios when working with CircleCi"><base href=https://blog.mhashim6.me/circleci-shell-guide/><link rel=canonical href=https://blog.mhashim6.me/circleci-shell-guide/ itemprop=url><meta name=url content="https://blog.mhashim6.me/circleci-shell-guide/"><meta name=twitter:url content="https://blog.mhashim6.me/circleci-shell-guide/"><meta property="og:url" content="https://blog.mhashim6.me/circleci-shell-guide/"><meta property="og:locale" content="en"><meta name=language content="English"><meta itemprop=image content="https://blog.mhashim6.me/images/circleci+shell.png"><meta property="og:image" content="https://blog.mhashim6.me/images/circleci+shell.png"><meta name=twitter:image content="https://blog.mhashim6.me/images/circleci+shell.png"><meta name=twitter:image:src content="https://blog.mhashim6.me/images/circleci+shell.png"><meta property="og:updated_time" content="2022-09-04T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=https://blog.mhashim6.mesitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><link rel=apple-touch-icon sizes=180x180 href=https://blog.mhashim6.me/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.mhashim6.me/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.mhashim6.me/favicon-16x16.png><link rel="shortcut icon" href=https://blog.mhashim6.me/favicon.ico><link rel=icon type=image/x-icon sizes="16x16 32x32" href=https://blog.mhashim6.me/favicon.ico><link rel=manifest href=https://blog.mhashim6.me/site.webmanifest><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#EDE3D9"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#17191C"><link rel=author href=https://blog.mhashim6.me/humans.txt><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"UpsideDownTrees","url":"https://blog.mhashim6.me","sameAs":["https://mhashim6.me","https://linkedin.com/in/mhashim6","https://github.com/mhashim6"]}</script><script>const storage=localStorage.getItem("dark-mode");("dark"===storage||!storage&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.setAttribute("data-theme","dark")</script><script src=https://blog.mhashim6.me/js/darkm.min.1be248604351b865213d07e5a761998a21e20d82ba86c4fe72cddc853f108b7d.js></script>
<link rel=stylesheet href=https://blog.mhashim6.me/css/style.min.4d5ef3221c9f3eeced5e45272e27bcddaa82bf9f0622e6c922d7f193dab67dec.css><link rel=stylesheet href=css/synatx.css></head><body class=single><header class=site-header><link rel=alternate type=application/rss+xml href=https://blog.mhashim6.me/index.xml title="The Upside-Down Trees"><div class=inner><p class="site-title slide-horizontal-invert"><a href=https://blog.mhashim6.me/>UpsideDownTrees</a></p><input type=checkbox id=check-menu class=check-menu hidden>
<label for=check-menu class="nav-btn hide-desktop" aria-label="Open/close menu"><span class=lines></span></label><nav class="site-nav hide-mobile slide-horizontal"><button class="theme__btn light--hidden" aria-label="Enable light mode"><svg aria-hidden="true" viewBox="0 0 24 24" id="sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
<button class="theme__btn dark--hidden" aria-label="Enable dark mode"><svg aria-hidden="true" viewBox="0 0 24 24" id="moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button><ul class=site-menu><li><a target=_blank href=https://t.me/UpsideDownTrees><span>Telegram</span></a></li><li><a target=_blank href=https://mhashim6.me><span>About me?</span></a></li><li><a href=https://blog.mhashim6.me/index.xml><span>RSS</span></a></li><li><a href=https://blog.mhashim6.me/posts/><span>Archive</span></a></li></ul></nav></div></header><main class=site-main><article><header class=subheader style=background-image:url(/images/circleci+shell.png)><div class="title-container slide-invert"><h1 class=post-title>The Missing Docs on CircleCI (+Shell)</h1><figcaption><i></i></figcaption><div><div class=taxonomy><a class="chip no-decor" href=https://blog.mhashim6.me/tags/circleci>CircleCI</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/shell>Shell</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/bash>Bash</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/data-wrangling>Data Wrangling</a>
<a class="chip no-decor" href=https://blog.mhashim6.me/tags/json>JSON</a></div></div></div></header><div class="content slide-invert"><h1 id=the-missing-docs-on-circleci--shell>The Missing Docs on CircleCI (+ Shell)</h1><p>Hi there! Many teams are relying on <a href=https://circleci.com>CircleCI</a> to handle their CI (Continuos Integration) pipelines (I know we do @<a href=https://www.instabug.com>Instabug</a>). CircleCI is actually very powerful. However, there are many scenarios you expect to be supported yet they (seemingly) are not. You&rsquo;ve looked up the docs and the communiy&rsquo;s collective knowledge yet you&rsquo;re faced with either dead ends or some very complex, not-safe solutions.</p><p>CircleCI is actually flexible (in its own way). You often can do (most of) the things you want to do. It&rsquo;s just that you have to do them <em>the CircleCI way</em>.</p><p>I&rsquo;ll provide here some Tools & Tips that will help You achieve many of the advanced scenarios you&rsquo;ll face.</p><h2 id=table-of-content>Table of Content</h2><ol><li><a href=#tools>Tools</a><ol><li><a href=#circle-cli>CircleCI CLI</a></li><li><a href=#circle-intellij-plugin>CircleCI Plugin for Intellij-based IDEs</a></li><li><a href=#shellcheck>ShellCheck</a></li><li><a href=#shfmt>shfmt</a></li></ol></li><li><a href=#circle-tips>How to <del>cope with depression</del> better approach CircleCI</a><ol><li><a href=#dynamic-parameters>Dynamic Parameters</a></li><li><a href=#dynamic-parameters-to-commands>Dynamic Parameters (to Commands)</a></li><li><a href=#env-var-in-shell>Using an Env. variable inside a shell script</a></li><li><a href=#shell-executable-permission>Getting “permission denied” when running a script even though it is executable</a></li></ol></li><li><a href=#shell-tips-and-tricks>Shell tips and tricks</a><ol><li><a href=#json-jq>Json comes into your shell house, how do you say hi?</a></li><li><a href=#math-bc>How to do math</a></li><li><a href=#fail-early>Fail-early</a></li><li><a href=#network-request-fail>Network request failure</a></li><li><a href=#curl-silence>cURLy output? Use this formula</a></li></ol></li></ol><h2 id=tools>Tools</h2><h3 id=circle-cli>CircleCI CLI</h3><p>If you want to validate that your <code>config.yml</code> file is syntactically correct <em>(because that’s only what you’ll get)</em> <em><strong>before</strong></em> pushing to GitHub and be greeted by a <code>build error</code>. Use <a href=https://circleci.com/docs/local-cli title=https://circleci.com/docs/local-cli>CircleCI’s local CLI</a> to static-check your file. it’ll not detect a type error, but it will detect a bad indentation or referencing a <code>job</code> name that doesn&rsquo;t exist. You know, everyday errors. <em>You get used to it</em>.</p><p>Install it then run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>circleci config validate
</span></span></code></pre></div><p>Now you’ve made sure you’ll only be bothered by the harder, less obvious errors that were not detected. That’s progress!</p><h3 id=circle-intellij-plugin>CircleCI Plugin for Intellij-based IDEs</h3><p>The title says it all. It basically is a <code>YAML</code> checker + some stuff that isn’t at all useful. But overall it will help you with some syntax errors (and false negatives) without manually looking for them. Install <a href=https://plugins.jetbrains.com/plugin/13690-circleci title=https://plugins.jetbrains.com/plugin/13690-circleci>here</a>.</p><h3 id=shellcheck>ShellCheck</h3><p>If you’re working with CircleCI, odds are you’re working with the shell to do some hacky whacky skkkriptin&rsquo;. And to make the process a tad less of a <em>spray n&rsquo; pray</em>, <code>shellcheck</code> will static-check your script, give you advice that you really should listen to, and even give you suggestions. It’s like asking grandpa to validate your scripts! You can use it online or install it <a href=https://www.shellcheck.net/ title=https://www.shellcheck.net/>here</a>, and if you’re using an Intellij-based editor/ IDE it’ll automatically be used by the bundled <code>Shell Script</code> plugin.</p><h3 id=shfmt>shfmt</h3><p>This is not a bad word, it’s just a bad abbreviation. <a href=https://github.com/mvdan/sh title=https://github.com/mvdan/sh>shfmt</a> is a shell formatter. To make your shell scripts less ugly. <a href=https://formulae.brew.sh/formula/shfmt title=https://formulae.brew.sh/formula/shfmt>Install on Hombrew</a> <em>(if you&rsquo;re on linux you know where to get your stuff).</em><br>Did I mention it’ll also be automatically picked and used by the bundled Shell Script plugin on Intellij-based editors/ IDEs? <em>this generation has it easy</em>.</p><hr><h2 id=circle-tips>How to <del>cope with depression</del> better approach CircleCI</h2><p>Here I’ll cover some use cases that are known to be really counter-intuitive (to put it nicely) in CircleCI.</p><h3 id=dynamic-parameters>Dynamic Parameters</h3><p>You want to pass a piece of data from a step to another. How to do this in CircleCI?</p><p><strong>The short version</strong>: You can’t.<br><strong>Why?</strong> You can’t pass inputs to <code>steps</code>. You can pass them to a <code>command</code> but even that won’t work for most cases (see below).</p><p><strong>Workaround:</strong> Your only hope (I mean it, there’s only one practical way so don’t bother) is to store this little value in the Environment Variables and retrieve it later. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>steps</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=w> </span><span class=nt>run</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Post release to GitHub repo </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>  </span><span class=l>|  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>set -e </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>rel_id=$(./scripts/post-internal-release.sh) </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>echo &#34;export REL_ID=&#39;$rel_id&#39;&#34; &gt;&gt; $BASH_ENV</span><span class=w>
</span></span></span></code></pre></div><p>We’ve stored the release id (<code>rel_id</code>) in <code>$BASH_ENV</code> and named it <code>REL_ID</code>. To access it in another <code>step</code>, or a <code>command</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>run</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Upload mapping files to github </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w>  </span><span class=l>|  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>./scripts/upload_mapping_to_github.sh ${REL_ID}</span><span class=w>
</span></span></span></code></pre></div><p>And here we retrieve it using the funky dollar sign: <code>${REL_ID}</code>.</p><hr><h3 id=dynamic-parameters-to-commands>Dynamic Parameters (to Commands)</h3><p>You want to pass a piece of data to a CircleCI <code>command</code>. The catch is that this parameter can be only determined in runtime (Say a script result or network response). How to do this in CircleCI?</p><p><strong>The short version</strong>: You can’t.<br><strong>Why?</strong> Because since CircleCI v2.1 all parameters will be inflated at parse time and not in runtime. Which means that little script result of yours is now just a script. Which means you’ve passed a script invocation as CircleCI dumb parameter. I hope you’re proud of yourself now.</p><p><strong>Workaround:</strong> One of the things CircleCI did so right was to allow passing <code>steps</code> as parameters to a CircleCI <code>command</code> (think higher-order functions). Using this, instead of passing the script (result) as a parameter, pass the <code>step</code> that calls this script as a parameter and it automatically runs in the same context as the command. Which means you can access the created files and the <code>env</code> of the job and the command.</p><p>Here, an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>post-github-release</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Post a release to GitHub repo </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parameters</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sdk-builder</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>steps </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w>  </span><span class=p>[]</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>is-pre-release</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>boolean </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w>  </span><span class=kc>false</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>company</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=l>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>steps</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=w> </span><span class=nt>steps</span><span class=p>:</span><span class=w> </span><span class=l>&lt;&lt; parameters.sdk-builder &gt;&gt;  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=w> </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./bla_bla_bla.sh</span><span class=w>
</span></span></span></code></pre></div><p>See that? <code>sdk-builder</code> is a <del>lambda</del> <code>step</code> that gets dynamically invoked based on the caller of this <code>command</code>. But the important thing is that <code>bla_bla_bla.sh</code> runs in the same context as <code>sdk-builder</code>; any file changes, <code>env</code> changes are accessible by both.</p><hr><h3 id=env-var-in-shell>Using an Env. variable inside a shell script</h3><p><strong>The short version</strong>: It’s completely fine, you just might be doing it wrong.</p><p><strong>How?</strong> By using the same magical dollar sign <code>$</code> to access anything shell-related, including the contents of the <code>env</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>PR_LINK</span><span class=o>=</span><span class=nv>$CIRCLE_PULL_REQUEST</span>
</span></span></code></pre></div><p>You see, CircleCI complies with the <code>POSIX</code> standard. but the reason you can’t access the <code>env</code> is not at all related to CircleCI. It’s because <em>you sir invoke the script the wrong way.</em></p><p>This is how to properly invoke a shell script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./script_to_run.sh
</span></span></code></pre></div><p>And not:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo sh script_to_run.sh
</span></span></code></pre></div><p>The latter invokes your script in a new <code>sh</code> env. that doesn&rsquo;t have access to the parent env. by default.
In order to do this you have to do 2 things:</p><ol><li><p>Add this line (<em>shebang</em>) to the very top of your script: <code>#!/bin/bash</code></p></li><li><p>Update your script permission to be executable: <code>sudo chmod +x your_script.sh</code></p></li></ol><hr><h3 id=shell-executable-permission>Getting “permission denied” when running a script even though it is executable</h3><p>When setting the permission of a script make sure to do this (specifically if it’s an already existing script):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo chmod +x your_script.sh 
</span></span><span class=line><span class=cl>git update-index --chmod<span class=o>=</span>+x your_script.sh
</span></span></code></pre></div><p>When you push, the second line makes sure the script in your remote repo. is also executable.</p><hr><h2 id=shell-tips-and-tricks>Shell tips and tricks</h2><h3 id=json-jq>Json comes into your shell house, how do you say hi?</h3><p>I know you’ve a couple of <code>grep</code>s and <code>tr</code>s ready for dealing with people like Json, but let me tell you how to do it <em><strong>for good</strong></em>: Use <a href=https://stedolan.github.io/jq/ title=https://stedolan.github.io/jq/>jq</a>. It’s tiny, effective, and has all the required syntax to wrangle the living bits out of this so-called json man. You can toy with it <a href=https://jqplay.org/ title=https://jqplay.org/>online</a> till you find the perfect filter and apply it just like with Instagram. For example, this is how I filter 7k+ entries in a json array to find a certain object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>job</span><span class=o>=</span><span class=k>$(</span>jq <span class=s1>&#39;.items[] | select(.name == &#34;job-requires-approval&#34;)&#39;</span>  <span class=o>&lt;&lt;&lt;</span>  <span class=s2>&#34;{items: [...]}&#34;</span><span class=k>)</span>  
</span></span><span class=line><span class=cl><span class=nv>approver_id</span><span class=o>=</span><span class=k>$(</span>jq <span class=s1>&#39;.approved_by&#39;</span>  <span class=o>&lt;&lt;&lt;</span>  <span class=s2>&#34;</span><span class=nv>$job</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span></code></pre></div><hr><h3 id=math-bc>How to do math</h3><p>Turns out math isn’t easy after all. At least for the shell. in order to do proper arithmetic ops in the shell you have to use a custom <code>GNU</code> language for it: <a href=https://en.wikipedia.org/wiki/Bc_(programming_language) title=https://en.wikipedia.org/wiki/Bc_(programming_language)>bc (basic calculator)</a>. In CircleCI, there’s a high chance that you’re running on a <code>debian-based</code> machine. So installing <code>bc</code> is as easy as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo  apt  install  bc
</span></span></code></pre></div><p>To use it, you can think of it as a simple C-like language:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>two</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span>  <span class=s2>&#34;1 + 1&#34;</span>  <span class=p>|</span>  bc<span class=k>)</span>
</span></span></code></pre></div><p>If you’re dealing with floating-point numbers add the <code>-l</code> flag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>variance</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span>  <span class=s2>&#34;</span><span class=nv>$delta</span><span class=s2> - </span><span class=nv>$tolerable</span><span class=s2>&#34;</span><span class=p>|</span>bc -l<span class=k>)</span>
</span></span></code></pre></div><p>To round a number, divide by <code>1</code> (bear with me):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span>  <span class=s2>&#34;1.7/1&#34;</span>  <span class=p>|</span>  bc  <span class=c1># prints 1</span>
</span></span></code></pre></div><hr><h3 id=fail-early>Fail-early</h3><p>A wise man once said</p><blockquote><p>It’s better to know that you’re failing than knowing that you’ve already failed.</p></blockquote><p>Let’s pretend that actually happened and put it into context: You have a <code>run step</code> or a script that runs multiple commands. Now when one of these commands fail, it doesn’t mean the script or the step will stop running the rest (by default). And this is bad.</p><p>To change this in a script you add this before your commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>set</span> -e <span class=c1># this bad boy </span>
</span></span><span class=line><span class=cl><span class=nb>echo</span>  <span class=s2>&#34;bla bla bla&#34;</span>  
</span></span><span class=line><span class=cl><span class=c1># some failing commands here....  </span>
</span></span><span class=line><span class=cl><span class=nb>echo</span>  <span class=s2>&#34;pffft&#34;</span>  <span class=c1># this won&#39;t be printed if a command fails before this line</span>
</span></span></code></pre></div><p>To change this in a <code>run step</code> is not so different:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>run</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Post release to GitHub repo </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>|  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>set -e</span><span class=w> </span><span class=c># that&#39;s our boy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>rel_id=$(./scripts/post-internal-release.sh)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>echo &#34;export REL_ID=&#39;$rel_id&#39;&#34; &gt;&gt; $BASH_ENV</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=network-request-fail>Network request failure</h3><p>Say you’re <code>curl</code>ing some endpoint and you want to fail the script/ <code>job</code> when the response code is not a major success. You can check if it’s <code>> 200</code> and <code>&lt; 300</code> or all sorts of tricks but there’s actually a native way to do it with <code>curl</code>: The fail flag <code>-f</code> this bad boy will fail the with an exit code that is guaranteed <code>> 0</code> when your response code is not a success:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -f -X GET <span class=s2>&#34;https://circleci.com/api/v2/workflow/</span><span class=nv>$WORKFLOW_ID</span><span class=s2>/job&#34;</span> -u <span class=s2>&#34;</span><span class=nv>$CIRCLE_TOKEN</span><span class=s2>&#34;</span>:
</span></span></code></pre></div><p>Combine this with the former tip and you have fail-early combination that’ll make sure you never fail twice <em>(at least in the same context)</em>.</p><hr><h3 id=curl-silence>cURLy output? Use this formula</h3><p>You have a script that does something and returns a value when it finishes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -f -X GET <span class=s2>&#34;https://circleci.com/api/v2/workflow/</span><span class=nv>$WORKFLOW_ID</span><span class=s2>/job&#34;</span> -u <span class=s2>&#34;</span><span class=nv>$CIRCLE_TOKEN</span><span class=s2>&#34;</span>:  
</span></span><span class=line><span class=cl><span class=nb>echo</span>  <span class=s2>&#34;result&#34;</span>
</span></span></code></pre></div><p>The problem here is that curl prints stuff too. so <code>"result"</code> won’t be the only output of your script. Luckily, you can tell <code>curl</code> to shut up (in a nice way) by using the <code>-s</code> flag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -s -f -X GET <span class=s2>&#34;https://circleci.com/api/v2/workflow/</span><span class=nv>$WORKFLOW_ID</span><span class=s2>/job&#34;</span> -u <span class=s2>&#34;</span><span class=nv>$CIRCLE_TOKEN</span><span class=s2>&#34;</span>:  
</span></span><span class=line><span class=cl><span class=nb>echo</span>  <span class=s2>&#34;result&#34;</span>
</span></span></code></pre></div><hr><p>Have a comment? Please post it right below.</p><button onclick='(()=>{navigator.share({url:"https://blog.mhashim6.me/circleci-shell-guide/"})})()'>
Share This Post <img src=https://img.icons8.com/ios-glyphs/22/17191C/share-rounded.png></button><div class=taxonomy><a class="chip category" href=https://blog.mhashim6.me/categories/tech>Tech</a>
<a class="chip category" href=https://blog.mhashim6.me/categories/guide>Guide</a></div><script id=telegram_comments async src=https://comments.app/js/widget.js?3 data-comments-app-website=b14MWwEx data-limit=1000 data-page-id=https://blog.mhashim6.me/circleci-shell-guide/ data-color=ceaa37 data-colorful=1 dark=0></script></div></article></main><footer class=site-footer><p class=copyright>© 2022 The Upside-Down Trees</p><ul class=social-links><li><a target=_blank class='icon icon-website' href=https://mhashim6.me aria-label="Follow on Website"></a></li><li><a target=_blank class='icon icon-linkedin' href=https://www.linkedin.com/in/mhashim6/ aria-label="Follow on LinkedIn"></a></li><li><a target=_blank class='icon icon-github' href=https://github.com/mhashim6 aria-label="Follow on GitHub"></a></li><li><a target=_blank class='icon icon-telegram' href=https://t.me/mhashim6 aria-label="Follow on Telegram"></a></li><li><a target=_blank class='icon icon-email' href=mailto:msg@mhashim6.me aria-label="Follow on Email"></a></li></ul></footer><script src=https://blog.mhashim6.me/js/prefixfree.min.9cea59c2cb403a83a6549aadada301521cf8b59b1abc0498e0a10432d186bd67.js></script></body></html>